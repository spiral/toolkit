!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@spiral-toolkit/core")):"function"==typeof define&&define.amd?define("@spiral-toolkit/form",["@spiral-toolkit/core"],t):"object"==typeof exports?exports["@spiral-toolkit/form"]=t(require("@spiral-toolkit/core")):e["@spiral-toolkit/form"]=t(e["@spiral-toolkit/core"])}(window,(function(__WEBPACK_EXTERNAL_MODULE__1__){return function(e){var t={};function s(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,o){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(s.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(o,r,function(t){return e[t]}.bind(null,r));return o},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s(s.s=4)}([function(e,t){const s={template:'<div class="alert alert-${type} alert-dismissible fade show" role="alert">${text}<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>',close:".close",place:"bottom",levels:{success:"success",info:"info",warning:"warning",error:"danger"},selector:"[data-message]",field:"[data-field]",fieldElement:"[data-input]",fieldTemplate:'<div data-message class="invalid-feedback" data-form-message>${text}</div>',fieldPlace:"bottom",fieldClasses:{success:"is-valid",info:"is-valid",warning:"is-invalid",error:"is-invalid"}};function o(e,t){return"object"!=typeof e&&(e={text:e,type:t}),e.text=e.text||e.message||e,e.type=e.type||t,e}s.levels.message=s.levels.success,s.levels.debug=s.levels.success,s.levels.info=s.levels.notice=s.levels.info,s.levels.danger=s.levels.critical=s.levels.alert=s.levels.emergency=s.levels.error,e.exports={defaults:s,showMessages(e){if(!e)return;let t=!1;const s=this;if(e.data&&(Object.keys(this.options.messages.levels).forEach(s=>{e.data[s]&&(this.showFormMessage(e.data[s],this.options.messages.levels[s]),t=!0)}),e.data.messages&&(this.showFieldsMessages(e.data.messages,"success"),t=!0),e.data.errors&&(this.showFieldsMessages(e.data.errors,"error"),t=!0),e.data.warnings&&(this.showFieldsMessages(e.data.warnings,"warning"),t=!0)),!t){let t;e.status?e.status>300&&(t=e.status?`${e.status} `:"",t+=e.statusText?e.statusText:"",t+=e.data&&!e.statusText?e.data:""):t=e,this.showFormMessage(t,this.options.messages.levels.error)}this._messages.forEach(e=>{e.close&&(e.closeHandler=s.removeMessage.bind(s,e),e.close.addEventListener("click",e.closeHandler))})},removeMessage(e,t){if(e.close&&e.close.removeEventListener("click",e.closeHandler),e.el.parentNode.removeChild(e.el),e.field){const t=e.field.querySelector(this.options.messages.fieldElement);t?t.classList.remove(this.options.messages.fieldClasses[e.type]):e.field.classList.remove(this.options.messages.fieldClasses[e.type])}t&&(t.preventDefault&&t.preventDefault(),this._messages.splice(this._messages.indexOf(e),1))},removeMessages(){const e=this;this._messages&&this._messages.forEach(t=>{e.removeMessage(t,!1)}),e._messages=[]},showFormMessage(e,t){let s,r=this.options.messages.template;e=o(e,t),Object.keys(e).forEach(t=>{e.hasOwnProperty(t)&&(r=r.replace(`\${${t}}`,e[t]))});const n=document.createElement("div");n.innerHTML=r;const a=n.firstChild;"bottom"===this.options.messages.place?this.node.appendChild(a):"top"===this.options.messages.place?this.node.insertBefore(a,this.node.firstChild):(s=document.querySelector(this.options.messages.place)).appendChild(a),this._messages.push({el:a,close:a.querySelector(this.options.messages.close)})},showFieldMessage(e,t,s,r){let n=r?e:window.sf.helpers.domTools.closest(e,this.options.messages.field),a=this.options.messages.fieldTemplate;if(!n)return;t=o(t,s);const i=n.querySelector(this.options.messages.fieldElement),l=n.querySelector(this.options.messages.selector);i?i.classList.add(this.options.messages.fieldClasses[s]):n.classList.add(this.options.messages.fieldClasses[s]),Object.keys(t).forEach(e=>{t.hasOwnProperty(e)&&(a=a.replace(`\${${e}}`,t[e]))});const c=document.createElement("div");c.innerHTML=a;const _=c.firstChild;"bottom"===this.options.messages.fieldPlace?i?n.insertBefore(_,i.nextSibling):l||n.appendChild(_):"top"===this.options.messages.fieldPlace?n.insertBefore(_,n.firstChild):(n=n.querySelector(this.options.messages.fieldPlace)).appendChild(_),this._messages.push({el:_,close:_.querySelector(this.options.messages.fieldClose),field:n,type:s})},showFieldsMessages(e,t){const s=this;window.sf.iterateInputs(this.node,e,(e,o)=>{s.showFieldMessage(e,o,t)}).forEach(e=>{Object.keys(e).forEach(o=>{const r=s.node.querySelector(`[data-message-placeholder="${o}"]`);r&&s.showFieldMessage(r,e[o],t,!0)})})}}},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE__1__},function(e,t){const s=function(e){return!!e&&(this.formRef=e,this.keyRegex=/[^\[\]]+/g,this.$form=null,this.$formElements=[],this.formObj={},!!this.setForm()&&(!!this.setFormElements()&&this.setFormObj()))};s.prototype.setForm=function(){switch(typeof this.formRef){case"string":this.$form=document.getElementById(this.formRef);break;case"object":this.isDomNode(this.formRef)&&(this.$form=this.formRef)}return this.$form},s.prototype.setFormElements=function(){return this.$formElements=this.$form.querySelectorAll("input, textarea, select"),this.$formElements.length},s.prototype.isDomNode=function(e){return"object"==typeof e&&"nodeType"in e&&1===e.nodeType},s.prototype.forEach=function(e,t){[].forEach?[].forEach.call(e,t):Object.keys(e).forEach(s=>{Object.prototype.hasOwnProperty.call(e,s)&&t.call(e,e[s])})},s.prototype.addChild=function(e,t,s,o){if(1===s.length){if("INPUT"===t.nodeName&&"radio"===t.type)return t.checked?void(e[s]=o):void 0;if("INPUT"===t.nodeName&&"checkbox"===t.type)return t.checked?(e[s]||(e[s]=[]),void e[s].push(o)):void 0;if("SELECT"===t.nodeName&&"select-multiple"===t.type){e[s]=[];const o=t.querySelectorAll("option[selected]");return void(o&&this.forEach(o,t=>{e[s].push(t.value)}))}e[s]=o}s.length>1&&(e[s[0]]||(e[s[0]]={}),this.addChild(e[s[0]],t,s.splice(1,s.length),o))},s.prototype.setFormObj=function(){let e,t=0;for(t=0;t<this.$formElements.length;t+=1)this.$formElements[t].name&&!this.$formElements[t].disabled&&(e=this.$formElements[t].name.match(this.keyRegex),this.addChild(this.formObj,this.$formElements[t],e,this.$formElements[t].value));return this.formObj},e.exports=s},function(e,t){let s=[];e.exports=function(e,t,o,r){return s=[],function e(t,o,r,n){Object.keys(o).forEach(a=>{if(!o.hasOwnProperty(a))return;const i=n?`${n}[${a}]`:a,l=Object.prototype.toString.call(o[a]),c=`[name='${i}']`;switch(l){case"[object Object]":e(t,o[a],r,i);break;case"[object Array]":o[a].forEach(e=>{const o=`[name='${i}[]'][value='${e}']`,n=t.querySelectorAll(o);0===n.length&&s.push(o);for(let e=0,t=n.length;e<t;e+=1)r(n[e],!0)});break;case"[object String]":case"[object Number]":const n=t.querySelectorAll(c);if(0===n.length){const e={};e[i]=o[a],s.push(e)}for(let e=0,t=n.length;e<t;e+=1)r(n[e],o[a]);break;default:console.error("unknown type -",l," and message",o[a])}})}(e,t,o,r),s.length,s}},function(e,t,s){e.exports=s(5)},function(e,t,s){const o=s(1),r=s(6).default;o.registerInstanceType(r,"js-sf-form"),e.exports=r},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0__),_formToObject__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_formToObject__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_formToObject__WEBPACK_IMPORTED_MODULE_1__),_formMessages__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(0),_formMessages__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_formMessages__WEBPACK_IMPORTED_MODULE_2__),_iterateInputs__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(3),_iterateInputs__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_iterateInputs__WEBPACK_IMPORTED_MODULE_3__),_styles_css__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(7),_styles_css__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_styles_css__WEBPACK_IMPORTED_MODULE_4__);const Form=function(e,t,s){this._construct(e,t,s)};Form.prototype=_spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0___default.a.createModulePrototype(),Form.prototype.name="form",Form.prototype._construct=function(e,t,s){this.init(e,t,s),this.mixMessagesOptions(),this.DOMEvents=new this.sf.helpers.DOMEvents,this.addEvents(),this.events=new this.sf.core.Events(["beforeSend","success","error","always"]),_spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0___default.a.iterateInputs=_iterateInputs__WEBPACK_IMPORTED_MODULE_3___default.a},Form.prototype.optionsToGrab={context:{processor:e=>e},self:{processor(){return this}},url:{domAttr:"action",value:"/"},method:{domAttr:"method",value:"POST"},lockType:{value:"default",domAttr:"data-lock-type"},messagesType:{value:"spiral",domAttr:"data-messagesType"},messages:{value:"",domAttr:"data-messages",processor(e,t,s){if(!t)return this.value;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){console.error("Form JSON.parse error: ",e)}return Object.assign(s.value,t)}},useAjax:{value:!0,domAttr:"data-useAjax",processor:(e,t)=>"boolean"==typeof t?t:("false"===(t=null!=t?t.toLowerCase():"")?t=!1:"true"===t&&(t=!0),t)},ajaxCallback:{value:!1,domAttr:"data-callback"},beforeSubmitCallback:{value:!1,domAttr:"data-before-submit"},afterSubmitCallback:{value:!1,domAttr:"data-after-submit"},headers:{value:{Accept:"application/json"},domAttr:"data-headers",processor(e,t,s){if(void 0===t||null==t)return this.value;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){console.error("Form JSON.parse error: ",e)}return Object.assign(s.value,t)}}},Form.prototype.mixMessagesOptions=function(){const e=this.sf.options.instances.form;this.options.messages={..._formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.defaults,...e&&e.messages&&e.messages[this.options.messagesType],...this.options.messages}},Form.prototype.onSubmit=function(e){if(this.sf.getInstance("lock",this.node))return e.preventDefault(),void e.stopPropagation();this.removeMessages(),this.options.data=this.getFormData(),window.FormData||0===this.options.context.querySelectorAll("input[type='file']").length||(this.options.useAjax=!1),this.events.trigger("beforeSend",this.options),this.options.useAjax&&(this.send(this.options),e.preventDefault(),e.stopPropagation())},Form.prototype.lock=function(e){if(!this.options.lockType||"none"===this.options.lockType)return;if(e)return void(this.sf.removeInstance("lock",this.node)||console.warn("You try to remove 'lock' instance, but it is not available or not started"));const t=this.sf.addInstance("lock",this.node,{type:this.options.lockType});t?this.options.onProgress=t.progress:console.warn("You try to add 'lock' instance, but it is not available or already started")},Form.prototype.showFormMessage=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.showFormMessage,Form.prototype.showFieldMessage=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.showFieldMessage,Form.prototype.showFieldsMessages=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.showFieldsMessages,Form.prototype.showMessages=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.showMessages,Form.prototype.removeMessages=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.removeMessages,Form.prototype.removeMessage=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.removeMessage,Form.prototype.processAnswer=function(e){this.options.messagesType&&this.showMessages(e)},Form.prototype.send=function(sendOptions){const that=this;if(this.lock(),sendOptions.beforeSubmitCallback){const fn=eval(sendOptions.beforeSubmitCallback);"function"==typeof fn&&fn.call(sendOptions)}this.sf.ajax.send(sendOptions).then(e=>(that.events.trigger("success",sendOptions),e),e=>(that.events.trigger("error",sendOptions),e)).then(e=>{that.lock(!0),that.processAnswer(e),that.events.trigger("always",sendOptions)}),this.sf.ajax.cancel&&this.sf.ajax.cancel()},Form.prototype.getFormData=function(){return window.FormData?new FormData(this.options.context):(console.log(`Form \`${this.options.context}\` were processed without FormData.`),new _formToObject__WEBPACK_IMPORTED_MODULE_1___default.a(this.options.context))},Form.prototype.setOptions=function(e){this.options=Object.assign(this.options,e)},Form.prototype.addEvents=function(){const e=this;this.DOMEvents.add([{DOMNode:this.options.context,eventType:"submit",eventFunction(t){e.onSubmit.call(e,t)}}])},Form.prototype.die=function(){this.DOMEvents.removeAll()},__webpack_exports__.default=Form},function(e,t,s){var o=s(8);"string"==typeof o&&(o=[[e.i,o,""]]);var r={insert:"head",singleton:!1};s(10)(o,r);o.locals&&(e.exports=o.locals)},function(e,t,s){(e.exports=s(9)(!0)).push([e.i,"[data-form-message] ~ [data-form-hint] {\n  display: none;\n}\n\n.is-invalid[data-message-placeholder]>.invalid-feedback,\n.is-invalid[data-field]>.invalid-feedback {\n  display: block;\n}\n","",{version:3,sources:["styles.css"],names:[],mappings:"AAAA;EACE,aAAa;AACf;;AAEA;;EAEE,cAAc;AAChB",file:"styles.css",sourcesContent:["[data-form-message] ~ [data-form-hint] {\n  display: none;\n}\n\n.is-invalid[data-message-placeholder]>.invalid-feedback,\n.is-invalid[data-field]>.invalid-feedback {\n  display: block;\n}\n"]}])},function(e,t,s){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s=function(e,t){var s=e[1]||"",o=e[3];if(!o)return s;if(t&&"function"==typeof btoa){var r=(a=o,i=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(i),"/*# ".concat(l," */")),n=o.sources.map((function(e){return"/*# sourceURL=".concat(o.sourceRoot).concat(e," */")}));return[s].concat(n).concat([r]).join("\n")}var a,i,l;return[s].join("\n")}(t,e);return t[2]?"@media ".concat(t[2],"{").concat(s,"}"):s})).join("")},t.i=function(e,s){"string"==typeof e&&(e=[[null,e,""]]);for(var o={},r=0;r<this.length;r++){var n=this[r][0];null!=n&&(o[n]=!0)}for(var a=0;a<e.length;a++){var i=e[a];null!=i[0]&&o[i[0]]||(s&&!i[2]?i[2]=s:s&&(i[2]="(".concat(i[2],") and (").concat(s,")")),t.push(i))}},t}},function(e,t,s){"use strict";var o,r={},n=function(){return void 0===o&&(o=Boolean(window&&document&&document.all&&!window.atob)),o},a=function(){var e={};return function(t){if(void 0===e[t]){var s=document.querySelector(t);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}e[t]=s}return e[t]}}();function i(e,t){for(var s=[],o={},r=0;r<e.length;r++){var n=e[r],a=t.base?n[0]+t.base:n[0],i={css:n[1],media:n[2],sourceMap:n[3]};o[a]?o[a].parts.push(i):s.push(o[a]={id:a,parts:[i]})}return s}function l(e,t){for(var s=0;s<e.length;s++){var o=e[s],n=r[o.id],a=0;if(n){for(n.refs++;a<n.parts.length;a++)n.parts[a](o.parts[a]);for(;a<o.parts.length;a++)n.parts.push(m(o.parts[a],t))}else{for(var i=[];a<o.parts.length;a++)i.push(m(o.parts[a],t));r[o.id]={id:o.id,refs:1,parts:i}}}}function c(e){var t=document.createElement("style");if(void 0===e.attributes.nonce){var o=s.nc;o&&(e.attributes.nonce=o)}if(Object.keys(e.attributes).forEach((function(s){t.setAttribute(s,e.attributes[s])})),"function"==typeof e.insert)e.insert(t);else{var r=a(e.insert||"head");if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}return t}var _,p=(_=[],function(e,t){return _[e]=t,_.filter(Boolean).join("\n")});function d(e,t,s,o){var r=s?"":o.css;if(e.styleSheet)e.styleSheet.cssText=p(t,r);else{var n=document.createTextNode(r),a=e.childNodes;a[t]&&e.removeChild(a[t]),a.length?e.insertBefore(n,a[t]):e.appendChild(n)}}function f(e,t,s){var o=s.css,r=s.media,n=s.sourceMap;if(r&&e.setAttribute("media",r),n&&btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(n))))," */")),e.styleSheet)e.styleSheet.cssText=o;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(o))}}var u=null,h=0;function m(e,t){var s,o,r;if(t.singleton){var n=h++;s=u||(u=c(t)),o=d.bind(null,s,n,!1),r=d.bind(null,s,n,!0)}else s=c(t),o=f.bind(null,s,t),r=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(s)};return o(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;o(e=t)}else r()}}e.exports=function(e,t){(t=t||{}).attributes="object"==typeof t.attributes?t.attributes:{},t.singleton||"boolean"==typeof t.singleton||(t.singleton=n());var s=i(e,t);return l(s,t),function(e){for(var o=[],n=0;n<s.length;n++){var a=s[n],c=r[a.id];c&&(c.refs--,o.push(c))}e&&l(i(e,t),t);for(var _=0;_<o.length;_++){var p=o[_];if(0===p.refs){for(var d=0;d<p.parts.length;d++)p.parts[d]();delete r[p.id]}}}}}])}));
//# sourceMappingURL=form.js.map